<link rel="import" href="../polymer/polymer-element.html">


<script>
  (() => {

    let stateStore = {};

    /**
     * Mixin for a shared State accross the DOM
     * @polymerMixin FuroStateMixin
     */
    FuroStateMixin = (superClass) => {
      /**
       * @polymerMixinClass
       */
      return class extends superClass {
        // First consumer becomes master
        constructor(stateName) {
          super();
          this._stateName = stateName;
          if (!stateStore[stateName]) {
            stateStore[stateName] = this;
          }
        }

        static get properties() {
          return {
            /**
             * The list of the consumers who will get notified.
             * If master disconnects, the next consumer becomes master
             */
            _subscribers: {
              type: Array,
              value: () => []
            },
            /**
             * Das gesamte config objekt
             *
             */
            _state: {
              type: Object,
              value: () => {
                return {}
              }
            }
          }
        }


        // benachrichtigen der subscriber bei set von _state ohne sich im kreis zu drehen.
        set(path, value) {
          if (path.startsWith('_state')) {
            let parts = path.split('.');
            if (parts.length > 1) {
              this.__appendPart(stateStore[this._stateName], parts)
            }
            Polymer.Path.set(stateStore[this._stateName], path, value);
            for (let i = 0; i < stateStore[this._stateName]._subscribers.length; i++) {
              stateStore[this._stateName]._subscribers[i].notifyPath(path, value);
            }
          } else {
            super.set(path, value);
          }
        }

        /**
         * Create deep Objects for non existing path in object.
         */
        __appendPart(target, parts) {
          let part = parts.shift();
          // create segment if it does not exist
          if (target[part] === undefined) {
            target[part] = {};
          }
          // append the tail
          if (parts.length > 1) {
            this.__appendPart(target[part], parts)
          }
        }

        // registrierung der Empfänger
        _register(subscriber) {
          subscriber._stateIndex = stateStore[this._stateName]._subscribers.push(subscriber) - 1;
        }

        _unregister(subscriber) {
          stateStore[this._stateName]._subscribers.splice(stateStore[this._stateName]._subscribers.indexOf(subscriber), 1);
          //delete when no subscribers are left
          if (stateStore[this._stateName]._subscribers.length === 0) {
            stateStore[this._stateName] = null;
          }
        }

        /**
         * Registirierung
         */
        connectedCallback() {
          super.connectedCallback();
          stateStore[this._stateName]._register(this);
        }

        /**
         * deregistrierung
         * TODO: übergabe der Kontrolle an nächsten consumer => stateStore[this._stateName] an den zweiten subscriber geben
         */
        disconnectedCallback() {
          super.disconnectedCallback();
          stateStore[this._stateName]._unregister(this);

        }
      }
    }
  })();
</script>

